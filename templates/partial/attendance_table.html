<!-- Attendance Filter Form -->
<form id="attendance-filter-form">
    <div class="form-group">
        <label for="month">Select Month:</label>
        <input type="month" id="month" name="month" class="form-control" value="{{ current_month }}">
    </div>
    <button type="submit" class="btn btn-primary">Filter</button>
</form>

<!-- Attendance Table -->
<table class="table table-bordered text-center">
    <thead>
        <tr>
            <th>Date</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Total Hours</th>
        </tr>
    </thead>
    <tbody id="attendance-table-body">
        {% if records %}
            {% for record in records %}
            <tr>
                <!-- Format the clock_in datetime to mm-dd-yyyy -->
                <td>{{ record.clock_in.strftime('%m-%d-%Y') if record.clock_in else 'N/A' }}</td>
                <!-- Format the clock_in time to 12-hour format -->
                <td class="clock-in" data-raw="{{ record.clock_in.strftime('%I:%M %p') if record.clock_in else 'N/A' }}">{{ record.clock_in.strftime('%I:%M %p') if record.clock_in else 'N/A' }}</td>
                <!-- Format the clock_out time to 12-hour format -->
                <td class="clock-out" data-raw="{{ record.clock_out.strftime('%I:%M %p') if record.clock_out else 'N/A' }}">{{ record.clock_out.strftime('%I:%M %p') if record.clock_out else 'N/A' }}</td>
                <!-- Calculate total hours dynamically (using JavaScript) -->
                <td class="total-hours">--</td>  
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="4">No attendance records found for this month.</td>
            </tr>
        {% endif %}
    </tbody>
</table>

<script>
// Function to calculate the difference between clock-in and clock-out times
function calculateTotalHours(clockIn, clockOut) {
    if (clockIn && clockOut) {
        const start = new Date(clockIn);
        const end = new Date(clockOut);
        const diffInMs = end - start;
        const diffInHours = diffInMs / (1000 * 60 * 60); // Convert to hours
        return diffInHours.toFixed(2); // Rounded to two decimal places
    }
    return 'N/A';
}

// Event listener for dynamically updating the total hours when the page is loaded
document.addEventListener("DOMContentLoaded", function() {
    const rows = document.querySelectorAll("tbody tr");
    rows.forEach(row => {
        const clockInCell = row.querySelector(".clock-in");
        const clockOutCell = row.querySelector(".clock-out");
        const totalHoursCell = row.querySelector(".total-hours");

        const clockIn = clockInCell ? clockInCell.dataset.raw : null;
        const clockOut = clockOutCell ? clockOutCell.dataset.raw : null;

        const totalHours = calculateTotalHours(clockIn, clockOut);
        totalHoursCell.textContent = totalHours;
    });
});

// Form submission (filtering the attendance records)
const form = document.getElementById('attendance-filter-form');
form.addEventListener('submit', function(event) {
    event.preventDefault();
    const month = document.getElementById('month').value;
    
    // Fetch filtered records using AJAX
    fetch(`/attendance/records?month=${month}`)
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('attendance-table-body');
            tableBody.innerHTML = ''; // Clear the current table body

            if (data.records && data.records.length > 0) {
                data.records.forEach(record => {
                    const row = document.createElement('tr');
                    const clockIn = record.clock_in ? new Date(record.clock_in).toLocaleString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A';
                    const clockOut = record.clock_out ? new Date(record.clock_out).toLocaleString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : 'N/A';
                    const totalHours = calculateTotalHours(record.clock_in, record.clock_out);

                    row.innerHTML = `
                        <td>${new Date(record.clock_in).toLocaleDateString()}</td>
                        <td class="clock-in" data-raw="${record.clock_in}">${clockIn}</td>
                        <td class="clock-out" data-raw="${record.clock_out}">${clockOut}</td>
                        <td class="total-hours">${totalHours}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4">No attendance records found for this month.</td></tr>';
            }
        })
        .catch(error => console.error('Error fetching data:', error));
});
</script>
